<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ВидеочатРК</title>
<style>
    body {
        background: black;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
    }
    h1 {
        color: red;
        padding: 10px;
    }
    .video-container {
        position: relative;
        display: inline-block;
        border: 3px solid red;
        background: black;
        margin: 10px;
        vertical-align: top;
    }
    video {
        display: block;
        max-width: 45vw;
        max-height: 45vh;
    }
    .speed-indicator {
        position: absolute;
        top: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.85);
        border-left: 3px solid red;
        border-bottom: 3px solid red;
        color: red;
        font-size: 12px;
        padding: 2px 6px;
        line-height: 1.2;
    }
</style>
</head>
<body>
<h1>Видеочат РК</h1>

<div class="video-container" id="container-local">
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="speed-indicator" id="speed-local">0 КБ/с</div>
</div>

<div class="video-container" id="container-remote">
    <video id="remoteVideo" autoplay playsinline></video>
    <div class="speed-indicator" id="speed-remote">0 КБ/с</div>
</div>

<script>
let localStream;
let peerConnection;

const config = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
};

async function startLocalStream() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
    } catch (err) {
        console.error("Ошибка доступа к медиа:", err);
    }
}

async function startConnection() {
    peerConnection = new RTCPeerConnection(config);

    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });

    peerConnection.ontrack = event => {
        document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    measureConnectionSpeed(peerConnection, "speed-local");
    measureConnectionSpeed(peerConnection, "speed-remote");

    // Здесь твоя логика сигналинга через сервер
}

async function measureConnectionSpeed(pc, elementId) {
    let previousBytes = 0;
    setInterval(async () => {
        try {
            const stats = await pc.getStats();
            let bytesNow = 0;
            stats.forEach(report => {
                if (report.type === "outbound-rtp" && !report.isRemote && report.bytesSent) {
                    bytesNow += report.bytesSent;
                }
                if (report.type === "inbound-rtp" && !report.isRemote && report.bytesReceived) {
                    bytesNow += report.bytesReceived;
                }
            });
            const bytesPerSecond = bytesNow - previousBytes;
            previousBytes = bytesNow;
            updateSpeedIndicator(elementId, bytesPerSecond);
        } catch (e) {
            console.error("Ошибка измерения скорости:", e);
        }
    }, 1000);
}

function updateSpeedIndicator(elementId, bytesPerSecond) {
    const el = document.getElementById(elementId);
    if (!el) return;

    let speed;
    if (bytesPerSecond >= 1000000) {
        speed = (bytesPerSecond / 1000000).toFixed(1) + ' МБ/с';
    } else if (bytesPerSecond >= 1000) {
        speed = (bytesPerSecond / 1000).toFixed(0) + ' КБ/с';
    } else {
        speed = bytesPerSecond + ' Б/с';
    }

    el.textContent = speed;
}

startLocalStream().then(startConnection);
</script>
</body>
</html>
